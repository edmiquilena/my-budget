{"version":3,"file":"movements.js","names":["myBalance","req","res","next","Movement","findAll","where","creator","user","id","type","attributes","Sequelize","fn","col","group","In","Out","length","dataValues","total","console","log","json","listMovements","limit","query","by","sort","page","filter","includes","JSON","parse","e","tags","Op","contains","count","totalRecords","offset","order","db","literal","result","status","error","message","getMovement","findByPk","params","movement","data","updateMovement","body","concept","amount","date","update","timestamp","removeMovement","destroy","removed","newMovement","create","build","save","created"],"sources":["../../src/controllers/movements.js"],"sourcesContent":["import {Movement, db} from '../lib/db'\nimport { Op, fn , Sequelize} from 'sequelize'\n\nexport const myBalance = async (req, res, next) => {\ntry {\nlet In = await Movement.findAll({  \n    where: {creator: req.user.id, type: true},\n    attributes: [ [Sequelize.fn('sum', Sequelize.col('amount')), 'total']],\n    group : ['Movement.type']\n})\nlet Out = await Movement.findAll({  \n    where: {creator: req.user.id, type: false},\n    attributes: [[Sequelize.fn('sum', Sequelize.col('amount')), 'total']],\n    group : ['Movement.type']\n})\nIn = In.length > 0 ? In[0].dataValues.total : 0;\nOut = Out.length > 0 ? Out[0].dataValues.total : 0;\nconsole.log(In  ,Out)\nreturn res.json({In, Out, total: In-Out})\n} catch(e){\n\n    return res.json({In: 0, Out: 0}) }\n  \n}\n\nexport const listMovements = async (req, res, next) => {\n    const limit = 10;\nlet {by = 'desc', sort = 'timestamp', page = 1, filter = {}} = req.query;\npage = (page < 1) ? 1 : page;\nby = (['asc','desc'].includes(by)) ? by : 'desc'\nsort = (['id','timestamp', 'createdAt'].includes(sort)) ? sort : 'id'\ntry {\nfilter = JSON.parse(filter)\n} catch(e) {\n    filter = {}\n}\nconsole.log(filter?.tags)\nif(filter.tags) {\n    filter.tags =   { [Op.contains]: filter.tags }\n}\nlet totalRecords = await Movement.count({where: {creator: req.user.id, ...filter}})\nlet result = await Movement.findAll({\n    offset:((page-1)*limit),\nlimit : limit,\n    \n    where: {creator: req.user.id,  ...filter},\n    attributes: ['id', 'type', 'concept', 'timestamp', 'amount', 'tags', 'createdAt'],\n    order: db.literal(`${sort} ${by}`)\n})\nif(!result) return res.status(500).json({error: true, message: 'something went wrong'})\n\nreturn res.json({error: false, result, totalRecords, page, filter})\n}\n\n\nexport const getMovement = async(req, res, next) => {\nconst movement = await Movement.findByPk(req.params.id, \n    {attributes: ['id', 'type', 'concept', 'timestamp', 'amount', 'tags', 'createdAt', 'creator']})\nif(!movement || movement.creator !== req.user.id) return res.json({error: true, message: \"No valid record.\"})\nres.json({error: false, data: movement})\n}\n\n\nexport const updateMovement = async(req, res, next) => {\n\nlet {concept, amount, tags, date} = req.body;\nlet update = await Movement.update({concept, amount, tags, timestamp: date}, {where: {id: req.params.id, creator: req.user.id}});\nif(!update) return res.json({error: true, message: \"something went wrong.\"})\nconst movement = await Movement.findByPk(req.params.id, \n    {attributes: ['id', 'type', 'concept', 'timestamp', 'amount', 'tags', 'createdAt', 'creator']})\nif(!movement || movement.creator !== req.user.id) return res.json({error: true, message: \"No valid record.\"})\nres.json({error: false, data: movement})\n}\n\nexport const removeMovement = async(req, res, next) => {\nlet destroy =    await Movement.destroy({where: {id: req.params.id, creator: req.user.id}});\nif(!destroy) return res.json({error:true, removed: false})\nreturn res.json({error:false, removed: true})\n}\nexport const newMovement = async(req, res, next) => {\n    try {\n    let {concept, amount, tags, type, date} = req.body;\n\n\n    let create =  Movement.build({concept, amount, tags, type, creator: req.user.id, timestamp: date })\n    await create.save();\n    return res.json({error:false, created: true, data: create})\n    } catch(e) {\n        console.log(e)\n        res.status(403).json({error: true, message: \"something went wrong.\"})\n    }\n}"],"mappings":"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"}